---
{"dg-publish":true,"permalink":"/nfinity7/etri/2023/","dgPassFrontmatter":true}
---

----

[[🏢Nfinity7/🔊ETRI오디오 시스템/🏢아파트 컨텐츠\|🏢아파트 컨텐츠]]
### 📜용역 계획서

[TM_Unity_기반_MPEGI_VR_콘텐츠_연동처리모듈_구현_계획_v01_2023_0425.pdf](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/e1b40126-019c-47d1-a9e4-d050bfc180ef/TM_Unity_%EA%B8%B0%EB%B0%98_MPEGI_VR_%EC%BD%98%ED%85%90%EC%B8%A0_%EC%97%B0%EB%8F%99%EC%B2%98%EB%A6%AC%EB%AA%A8%EB%93%88_%EA%B5%AC%ED%98%84_%EA%B3%84%ED%9A%8D_v01_2023_0425.pdf)

### ❓질문

- ~~카페 컨텐츠의 EIF는 새로 만들어야 하는지?~~ **⇒ 안 만듦**
- 엠펙 유니티 프로젝트에 카페 컨텐츠 합치는 작업중에 OSC메세지 연동확인을 해야할텐데 엠펙AEP와 연동 테스트를 자몽에서 할 수 있는지?
- 할 수 있다면 리스너파일, TCF파일, 비트스트림(?) 파일을 제공해 주는지?
- ~~신규 컨텐츠도 엠펙 프로젝트에 합치는것인지?~~ **⇒ 안 합침**

### ❗엠펙 프로젝트 알아낸것

- 컨트롤러 인풋은 `InputManager`에 이벤트가 있다.
- 텔레포트와 UI켜고 끄기 버튼 이벤트 할당은 InputListener에서 한다.
- 씬을 넘어가서 테스트를 하기위한 TCF파일과 리스터 파일이 필요할 것 같다. ⇒ 문의하기
    - TCF파일: [씬 이름, 오디오 파일의 정보와 경로] 등을 정의한 json파일
    - 리스너 파일: [테스트 타입, 시퀀스ID, 컨디션 셋] 등을 정의한 json파일
- `_Main`씬에서 맥스 세팅을 안해놓고 플레이를 시작하면 `UIManager`의 `NextButton` 프로퍼티가 `null`을 리턴해서 에러가 난다.
- **씬을 이동하는곳**은 `SceneManagerMushraVR.cs`
    - 이곳에서 MAX에서 받은 **씬 이름**으로 씬을 로드한다.
    - `SceneManager.LoadScene`을 쓰지않고 `SteamVR`의 함수를 사용했다.
- 플레이어(카메라)는 돈 디스트로이가 아니다 **⇒ `VRTKSDK`오브젝트**
    - 하지만 UI가 돈 디스트로이다 **⇒ `MushraUI`오브젝트**
- 컨텐츠 씬에 넘어갔을 때 pre룸으로 이동시키는 스크립트는 **⇒ `BeginScene.cs`**
    - `Pre-SceneRoom`프리팹 아래에 **`Capsule`오브젝트에 달려있다**
- `SceneSync` 컴포넌트에 다이나믹 오브젝트 리스트가있음
    - **자동차들**을 이쪽에 넣어야 할거같음
- `PreRoom`에서 헤드폰 눌렀을 때 이동하는 곳(컨텐츠가 시작되는 곳)을 정하는건
    - `TaskTargetLocations`의 `TargetLocationIndicatorsArray`의 `[0]`번째 인듯

### ❗엠펙의 컨트롤러 이동 텔레포트 정리
- `VRTK_Basiceleport`에서
- `DoTelePort` → `delayedteleport` → `SetNewPosition` → `CheckTerrainCollision`
- 위 함수 순서대로 이루어지면서 CheckTerrainCollision을 호출할 때 이동이 발생
- 하지만 이 방법은 터레인이 필수로 필요하다
- 텔레포트 도착지의 콜라이더를 검출하는곳은
    - ⇒ `VRTK_Pointer.cs`의 `ExecuteSelectionButtonAction()`함수
- 텔레포트 마커 관련한거는 `VRTK_DestinationMarker.cs`  스크립트인듯

### 엠펙 프로젝트 UI관련 정리

- **`AB테스트UI`** 끄고 켜는곳
    - UIManager.cs에서 **`PressButtonTwo` → `MenuToggleCommand**` 순서로 호출
- **UI포인터** 켜고 끄는 곳
    - `InputListener.cs`의 **`UpdateControllerStatus()`**
    - `VRTK_UIPointer`를 켜고끄면 포인터 라인도 켜고꺼지는건 아님
    - 라인을 담당하는곳은 `VRTK_StraightPointerRenderer` 스크립트로 추정됨
        - 위 스크립트의 `ToggleRenderer()`함수에서 `ToggleElement()`함수를 호출하는데
        - `ref`로 `tracerVisible`, `cursorVisible` 변수를 넘기고
        - 이 변수 두개가 `true`가 되면 라인이 활성화 되는것으로 보임
        - `public`으로 포인터를 토글시킬 방법은
        - ⇒ `VRTK_BasePointerRenderer`의 `Toggle()`함수를 사용해야할 듯
- `VRTK_UIPointer` → UI와 상호작용은 이쪽의 이벤트를 통하는듯 함
- 캔버스에 `VRTK_UI Canvas` 컴포넌트만 달려있으면
    - 그 캔버스 아래에 UI속성들 ⇒ 버튼, 슬라이더 …등은
    - `VRTK_UIPointer`로 상호작용이 가능함
- 컨트롤러 버튼 이벤트를 강제 발동 시킬 방법 찾는 중
    - ~~VRTK_ControllerEvents.cs에있는 public 함수들이 가능성 있어보임~~
    - ~~OnTriggerClicked(ControllerInteractionEventArgs e) ← 요함수~~
    - 위 방법은 실패
    - `InputListenr.cs` 스크립트를 상속받아서 새로 강제 토글 함수를 만들었음
    - `VRTK_Pointer.cs` 스크립트도 상속받아서 이거도 강제 턴오프 함수 만들었음

### 요구사항
- 카페씬에서는 엠펙UI와 우리UI를 둘다 띄워야 함
- 기존 UI가 머리를 따라오던 기능은 배제해야 함
- 기존 엠펙 스크립트는 건들면 안됨

### 기타 덜 중요한 메모
- ETRI에서 준 TCF파일의 이벤트ID가 예전걸로 돼있었다.
    - 그래서 단발성 오디오들이 실행이 안됨
    - 그래서 메일 뒤져서 중간에 바꼈던 이벤트ID로 바꿔줬음 (2월 17일 메일)
- 커피머신의 이벤트ID는 21번

### 이벤트ID 표
|               |                                                    |     |            |               |
| ------------- | -------------------------------------------------- | --- | ---------- | ------------- |
|               |                                                    |     | 기존 index | 수정 후 index |
| object on/off | `<Update id="upd:TurnOnCars" index="0" >`          |     | 0          | 0             |
|               | `<Update id="upd:TurnOffCars" index="1" >`         |     | 1          | 1             |
|               | `<Update id="upd:TurnOnPiano" index="2" >`         |     | 2          | 2             |
|               | `<Update id="upd:TurnOffPiano" index="3" >`        |     | 3          | 3             |
|               | `<Update id="upd:TurnOnBird" index="16" >`         |     | 16         | 4             |
|               | `<Update id="upd:TurnOffBird" index="17" >`        |     | 17         | 5             |
|               | `<Update id="upd:TurnOnCafeSpeaker" index="6" >`   |     | 6          | 6             |
|               | `<Update id="upd:TurnOffCafeSpeaker" index="7" >`  |     | 7          | 7             |
|               | `<Update id="upd:TurnOnPeople" index="34" >`       |     | 34         | 8             |
|               | `<Update id="upd:TurnOffPeople" index="35" >`      |     | 35         | 9             |
|               | `<Update id="upd:TurnOnPhone" index="36" >`        |     | 36         | 10            |
|               | `<Update id="upd:TurnOffPhone" index="37" >`       |     | 37         | 11            |
|               | `<Update id="upd:TurnOnParkSpeaker" index="21" >`  |     | 21         | 12            |
|               | `<Update id="upd:TurnOffParkSpeaker" index="22" >` |     | 22         | 13            |
|               | `<Update id="upd:TurnOnShopSpeaker" index="30" >`  |     | 30         | 14            |
|               | `<Update id="upd:TurnOffShopSpeaker" index="31" >` |     | 31         | 15            |
| Event         | <!-- 커피머신 -->                                  |     |            |               |
|               | `<Update id="upd:TurnOnCoffeeMachine" index="4" >` |     | 4          | 21            |
|               | `<Update id="upd:PlayWindow2" index="19" >`        |     | 19         | 22            |
|               | `<Update id="upd:WindowPos2" index="29" >`         |     | 29         | 23            |
|               | `<Update id="upd:PlayDoor" index="20" >`           |     | 20         | 24            |
|               | `<Update id="upd:DoorRot" index="27" >`            |     | 27         | 25            |
|               |                                                    |     |            |               |
| L3 update     | `<Update id="upd:AmbulancePos" index="8" >`        |     | 8          | 31            |
|               | `<Update id="upd:MotorBikePos" index="9" >`        |     | 9          | 32            |



### `Recreation Musinc`, `Thunder`가 작업된 프로젝트에 병합할 때 삭제해야할 파일, 폴더들 정리
```powershell
- 폴더
...\\Assets\\NaughtyAttributes
- 파일들
...\\Assets\\_Recreation_Music\\FBX\\PA_treeSpeaker_001.fbx
...\\Assets\\_Recreation_Music\\FBX\\PA_treeSpeaker_001.fbx.meta
...\\Assets\\_Recreation_Music\\Material\\PA_treeSpeaker_001.mat
...\\Assets\\_Recreation_Music\\Prefabs\\PA_treeSpeaker_001.prefab
...\\Assets\\_Recreation_Music\\Prefabs\\PA_treeSpeaker_001.prefab.meta
...\\Assets\\_Recreation_Music\\Texture\\PA_treeSpeaker_001.png
...\\Assets\\_Recreation_Music\\Texture\\PA_treeSpeaker_001.png.meta
...\\Assets\\_Recreation_Music\\Texture\\PA_treeSpeaker_MTL_001.png
...\\Assets\\_Recreation_Music\\Texture\\PA_treeSpeaker_MTL_001.png.meta
...\\Assets\\_Recreation_Music\\Texture\\PA_treeSpeaker_NRM_001.png
...\\Assets\\_Recreation_Music\\Texture\\PA_treeSpeaker_NRM_001.png.meta

```


----

### 바뀐 피아노 트랜스폼
###### 오브젝트 소스
```xml
<ObjectSource id="src:Piano" position="16.22 0.453 7.34" orientation="-0.417 0 0" signal="signal:JazzPianoPlay" active="true" gainDb="0" mode="continuous" />
```
###### 메쉬
```xml
  <Mesh id="mesh:Piano" position="16.222 1.298 7.294" orientation="-180 0 0">

    <Vertex index="0" position="1.2429 -0.8638 -0.5793" />

    <Vertex index="1" position="-1.2429 -0.8638 -0.5793" />

    <Vertex index="2" position="1.2429 0.8638 -0.5793" />

    <Vertex index="3" position="-1.2429 0.8638 -0.5793" />

    <Vertex index="4" position="1.2429 0.8638 0.5793" />

    <Vertex index="5" position="-1.2429 0.8638 0.5793" />

    <Vertex index="6" position="1.2429 -0.8638 0.5793" />

    <Vertex index="7" position="-1.2429 -0.8638 0.5793" />

    <Vertex index="8" position="1.2429 0.8638 -0.5793" />

    <Vertex index="9" position="-1.2429 0.8638 -0.5793" />

    <Vertex index="10" position="1.2429 0.8638 0.5793" />

    <Vertex index="11" position="-1.2429 0.8638 0.5793" />

    <Vertex index="12" position="1.2429 -0.8638 0.5793" />

    <Vertex index="13" position="1.2429 -0.8638 -0.5793" />

    <Vertex index="14" position="-1.2429 -0.8638 -0.5793" />

    <Vertex index="15" position="-1.2429 -0.8638 0.5793" />

    <Vertex index="16" position="-1.2429 -0.8638 -0.5793" />

    <Vertex index="17" position="-1.2429 0.8638 -0.5793" />

    <Vertex index="18" position="-1.2429 0.8638 0.5793" />

    <Vertex index="19" position="-1.2429 -0.8638 0.5793" />

    <Vertex index="20" position="1.2429 -0.8638 0.5793" />

    <Vertex index="21" position="1.2429 0.8638 0.5793" />

    <Vertex index="22" position="1.2429 0.8638 -0.5793" />

    <Vertex index="23" position="1.2429 -0.8638 -0.5793" />

    <Face index="0" material="mat:Piano" vertices="0 2 3" />

    <Face index="1" material="mat:Piano" vertices="0 3 1" />

    <Face index="2" material="mat:Piano" vertices="8 4 5" />

    <Face index="3" material="mat:Piano" vertices="8 5 9" />

    <Face index="4" material="mat:Piano" vertices="10 6 7" />

    <Face index="5" material="mat:Piano" vertices="10 7 11" />

    <Face index="6" material="mat:Piano" vertices="12 13 14" />

    <Face index="7" material="mat:Piano" vertices="12 14 15" />

    <Face index="8" material="mat:Piano" vertices="16 17 18" />

    <Face index="9" material="mat:Piano" vertices="16 18 19" />

    <Face index="10" material="mat:Piano" vertices="20 21 22" />

    <Face index="11" material="mat:Piano" vertices="20 22 23" />

  </Mesh>
```



### ✅ TODO
##### Archive
- [x] 수정된 DCF파일 적용하고 이벤트 오디오 테스트 해보기
- [x] 카페씬과 리소스를 기존 엠펙 프로젝트에 옮겨보고 작동된다면 리소스 전송하기
    - [x] 빌드세팅 아래에서 두번째, 세번째 확인하고 지우기 → 일단 안지우고 보냈음 ✅ 2023-08-24
    - [x] `ProjectSettings` 폴더안에 `EditorBuildSettings.asset` 잊지말기
    - [x] 너티 어트리뷰트 폴더 기존에 있으면 삭제해달라고 적기
    - [x] `PA_TreeSpeaker` fbx랑 텍스쳐랑 매테리얼이랑 프리팹도 다 삭제해야됨
- [x] 리소스 모음 파일 전송 이후에 소스트리 변경사항 동기화하기 ✅ 2023-08-23
- [x] 한글로 된 에셋 이름 바꾸기 ✅ 2023-08-28
	- [x] 이걸로 인해 기존에 옮겼던 파일들 삭제하고 다시 옮겨달라고 메일에 적어야할 듯 ✅ 2023-08-24
- [x] 피아노 뒤 공간? 에 보이는 바닥을 카페 바닥과 같은걸로 처리해 달라고함 ✅ 2023-08-24
	- [x] `Plane`을 새로 깔고  카페 바닥이랑 같은 `Material`을 적용함 ✅ 2023-08-24
	- [x] 이거 파일이 누락된건지 확인할 수가 없다고 함 원인 분석 필요 ✅ 2023-08-28
- [x] 컨텐츠가 시작될때 커피머신 오디오가 재생되는 문제 → 어디선가 21번 `EventID`를 보내고있을 것 → 피아노 ON `EventID`가 잘못돼있었음 ✅ 2023-08-24
	- [x] 피아노 ON `EventID` 수정한 거 원본 프로젝트에도 수정하기 ✅ 2023-08-24
- [x] wet, dry 텔레포트하면 UI 망가지는 버그 수정하기 ✅ 2023-08-24
- [x] 커튼 방의 바닥은 텔레포트 못 찍게 만들기 ✅ 2023-08-24
	- [x] 일단 텔레포트를 못하는 바닥을 만들 방법 찾기 ✅ 2023-08-24
- [x] Reverberation메뉴 텔레포트(wet, dry 텔레포트) 했을 때 UI토글이 고장나는 문제 ✅ 2023-08-24
- [x] 앰뷸런스 소리에 노이즈가 들리는지 확인하고 메일에 의견 첨부하기 ✅ 2023-08-24
##### Live
- [ ] EIF를 수정해달라고 요청받음
    - [x] 피아노 바뀐 위치 EIF좌표계 변환해서 메일로 보내기 ✅ 2023-08-24
    - [x] ~~메쉬 베이커로 카페 통짜메쉬 만들어보기~~ ✅ 2023-08-28
        - [x] ~~지금 만든거에서 계단이랑 일부 누락된 메쉬 채워서 다시 베이크하기~~ ✅ 2023-08-28
    - [x] 카페 건물 단순메쉬에 창문쪽 구멍 뚫어달라고 봉기팀장님께 요청 ✅ 2023-09-04
        - [x] 수정 완료되면 EIF 생성 ✅ 2023-09-04
- [x] 인트로 씬(프리 룸) 설명 및 스크린 샷 적용 ✅ 2023-08-28
	- [x] 수정 파일 전송 ✅ 2023-09-01
	- [x] 스크린 샷은 따로 메일로 한번 더 보내드리기 ✅ 2023-09-01
- [x] 프리룸 UI캡쳐 리소스 적용 ✅ 2023-09-04
- [x] 프리룸 내에서 텔레포트 안되는 문제 수정 ✅ 2023-09-04
- [x] 들어가면 안되는부분에 들어가면 시야를 안보이게? ✅ 2023-09-04
- [x] 차폐 텔레포트 위치 조정 ✅ 2023-09-04